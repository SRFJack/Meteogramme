<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteogramme</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { background-color: black; color: white; font-family: Verdana, sans-serif; text-align: center; }
        h1 { font-size: 40px; margin: 20px 0; }
        #map { height: 600px; width: 1100px; margin: auto; }
        .control-box { 
        margin: 4px; 
        padding: 4px; 
        background: black; 
        color: white; 
        display: inline-block; 
        text-align: left; 
        font-size: 20px;
        font-weight: bold;
    }
    select { 
        background: black; 
        color: white; 
        border: 1px solid white; 
        font-size: 20px;
    }
    .control-box label { display: inline-block; width: auto; margin-right: 5px; }
    .control-box select { display: inline-block; width: auto; }
    </style>
</head>
<body>
    <h1>Meteogramme</h1>
    <div class="control-box">
        <label for="model-select">Modell: </label>
        <select id="model-select" onchange="updateMarkers()">
            <option value="EURO1k">EURO1k</option>
            <option value="SWISS1k">SWISS1k</option>
            <option value="ECMWF">ECMWF</option>
            <option value="AIFS">AIFS</option>
            <option value="GFS">GFS</option>
        </select>
        <br>
        <label for="time-select">Lauf: </label>
        <select id="time-select"></select>
        <br>
        <label for="new-tab-true"><span style="font-size: 0.6em;">Neuer Tab:</span></label>
        <input type="radio" id="new-tab-true" name="new-tab" value="true" checked>
        <label for="new-tab-true"><span style="font-size: 0.6em;">Ja</span></label>
        <input type="radio" id="new-tab-false" name="new-tab" value="false">
        <label for="new-tab-false"><span style="font-size: 0.6em;">Nein</span></label>
    
    </div>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([46.8, 8.3], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const cityCoords = {
            "Bern": [46.95, 7.45], "Zuerich": [47.38, 8.51], "Basel": [47.56, 7.58], "Luzern": [47.05, 8.32], 
            "Geneve": [46.21, 6.15], "Lugano": [46.00, 8.96], "StGallen": [47.41, 9.32], "Chur": [46.86, 9.52], 
            "Sion": [46.22, 7.30], "Thun": [46.75, 7.61], "Solothurn": [47.21, 7.57], "Aarau": [47.39, 8.06], 
            "Buchs": [47.18, 9.48], "LaChauxDeFonds": [47.09, 6.82], "Frauenfeld": [47.57, 8.91], "Guettingen": [47.6, 9.3], 
            "Altdorf": [46.87, 8.64], "Magadino": [46.16, 8.96], "Biasca": [46.36, 8.96], "Linthebene": [47.19, 8.97], 
            "Orbe": [46.73, 6.55], "Ilanz": [46.77, 9.21], "Meiringen": [46.73, 8.17], "EbnatKappel": [47.27, 9.11], 
            "Delsberg": [47.36, 7.36], "Bulle": [46.62, 7.05], "Moehlin": [47.56, 7.85], "Adelboden": [46.49, 7.57], 
            "Samedan": [46.53, 9.88], "Unterengadin": [46.83, 10.38], "Entlebuch": [46.99, 8.06], "Glarus": [47.04, 9.07], 
            "Poschiavo": [46.32, 10.06], "Davos": [46.81, 9.84], "Ambri": [46.51, 8.70], "Zermatt": [46.02, 7.75]
        };

        // Define valid cities for each model
        const validCities = {
            "EURO1k": Object.keys(cityCoords),
            "SWISS1k": ["Bern", "Zuerich", "Basel", "Luzern", "Geneve", "Lugano", "StGallen", "Chur", "Sion", 'Thun',
            'Aarau', 'LaChauxDeFonds', 'Adelboden', 'Entlebuch', 'Davos', 'Altdorf', 'Buchs', 'Biasca'],
            "ECMWF": Object.keys(cityCoords),
            "AIFS": Object.keys(cityCoords),
            "GFS": ["Zuerich"]
        };

        let markers = [];

        function updateMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const modelValue = document.getElementById('model-select').value;
            const validCityList = validCities[modelValue];

            Object.entries(cityCoords).forEach(([city, coords]) => {
                const [lat, lon] = coords;
                if (validCityList.includes(city)) {
                    const marker = L.marker(coords).addTo(map)
                        .bindTooltip(city, { permanent: false })
                        .on('click', function(event) {
                            let link;
                            const timeValue = document.getElementById('time-select').value;
                            if (modelValue === "ECMWF") {
                                link = `https://charts.ecmwf.int/products/opencharts_meteogram?base_time=${timeValue}&epsgram=classical_10d&lat=${lat}&lon=${lon}&station_name=${city}`;
                            } else if (modelValue === "AIFS") {
                                link = `https://charts.ecmwf.int/products/aifs_opencharts_meteogram?base_time=${timeValue}&epsgram=aifs_classical_10d&lat=${lat}&lon=${lon}&station_name=${city}`;
                            } else if (modelValue === "GFS") {
                                link = "https://www.meteodat.ch/meteogrammzurich.html";
                            } else {
                                link = `https://met.metweb.ch/modelviewer/plots/${modelValue}/${timeValue}/${timeValue}_${modelValue}_CH_Meteogramm_${city}_00000.png`;
                            }

                            const openInNewTab = document.querySelector('input[name="new-tab"]:checked').value === "true";

                            if (openInNewTab) {
                                window.open(link, '_blank'); // Open in a new tab
                            } else {
                                window.location.href = link; // Open in the same tab
                            }
                        });
                    markers.push(marker);
                }
            });
        }

        const timeSelect = document.getElementById('time-select');
        const now = new Date();
        now.setUTCMinutes(0, 0, 0);
        now.setUTCHours(Math.floor((now.getUTCHours() - 2) / 6) * 6);
        
        const times = [];
        for (let i = 0; i < 5; i++) {
            const formattedTime = now.toISOString().replace(/[-:T]/g, '').slice(0, 12);
            const displayTime = `${now.getUTCDate()}. ${now.toLocaleString('de-DE', { month: 'long' })} ${now.getUTCFullYear()} - ${String(now.getUTCHours()).padStart(2, '0')} UTC`;
            times.push({ code: formattedTime, label: displayTime });
            now.setUTCHours(now.getUTCHours() - 6);
        }
        times.forEach(time => {
            const option = document.createElement('option');
            option.value = time.code;
            option.textContent = time.label;
            timeSelect.appendChild(option);
        });

        updateMarkers();
    </script>
</body>
</html>