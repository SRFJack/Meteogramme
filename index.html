<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteogramme</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { background-color: #2C3E50; color: #ADD8E6; font-family: Verdana; }
        #map { height: 600px; width: 900px; margin-left: 0; }

        .control-box { margin: 5px 0; padding: 4px; text-align: left; font-size: 15px; }
        .radio-group { line-height: 1.6; }
        .radio-group label { margin-right: 15px; font-size: 14px; }

        select { background: #282A36; color: #DCDCDC; border: 0; font-size: 15px; margin-top: 6px; }

        .toggle-btn {
            padding: 5px 10px;
            background-color: #2C3E50;
            color: #ADD8E6;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        .toggle-btn.active { background-color: #2196F3; }

        .gallery-item {
            position: relative;
            border: 1px solid #666;
            border-radius: 6px;
            overflow: hidden;
            background: #111;
        }

        .gallery-item img {
            width: 100%;
            display: block;
        }

        .gallery-close {
            position: absolute;
            top: 4px;
            right: 6px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 5px;
            font-size: 20px;
            border-radius: 3px;
            cursor: pointer;
        }

        .gallery-item {
            position: relative;
            border: 1px solid #666;
            border-radius: 6px;
            overflow: hidden;
        }
        .gallery-item img {
            width: 100%;
            display: block;
        }

        #gallery {
            display: grid;
            gap: 8px;
            align-items: start;
        }

        #gallery-clear {
            font-size: 1.2em;
            padding: 8px 14px;
        }
    </style>
</head>
<body>

<div class="control-box">
    <div class="radio-group">
        <label><input type="radio" name="model" value="ECMWF"> ECMWF</label>
        <label><input type="radio" name="model" value="GFS"> GFS</label>
        <label><input type="radio" name="model" value="AIFS"> AIFS</label>
        <br>
        <label><input type="radio" name="model" value="EURO1k" checked> EURO1k</label>
        <label><input type="radio" name="model" value="ICOND2"> ICOND2</label>
    </div>
    <select id="time-select"></select>
    <br>
    <button id="new-tab-button" class="toggle-btn">Neuer Tab: AUS</button>
    <button id="gallery-button" class="toggle-btn">Galerie: AUS</button>
</div>

<div id="map"></div>

<div id="gallery-section" style="display:none; margin-top:15px;">

    <!-- Spaltenzahl -->
    <label for="gallery-cols" style="margin-right:6px;">Spalten:</label>
    <select id="gallery-cols" style="width:50px;">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
    </select>
    
    <!-- Alle löschen -->
    <button id="gallery-clear" class="toggle-btn">Alle löschen</button>

    <!-- Bildzoom -->
    <label for="gallery-size" style="margin-left:20px; margin-right:6px;">Zoom:</label>
    <input id="gallery-size" type="range" min="50" max="220" value="100" style="width:200px;">


    <div id="gallery" style="margin-top:10px; display:grid; gap:6px;"></div>
</div>

<script>
const map = L.map('map').setView([46.8, 8.4], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.scrollWheelZoom.disable();

map.on('wheel', function (e) {
    if (e.originalEvent.ctrlKey) {
        map.scrollWheelZoom.enable();
        setTimeout(() => map.scrollWheelZoom.disable(), 50);
    } else {
        const msg = document.getElementById('ctrl-zoom-msg');
        if (msg) {
            msg.style.opacity = 1;
            clearTimeout(msg.timeout);
            msg.timeout = setTimeout(() => msg.style.opacity = 0, 800);
        }
    }
});

const cityList = [
    [46.95, 7.45, "Bern", "BRN"],
    [47.38, 8.51, "Zürich", "ZRH"],
    [47.56, 7.58, "Basel", "BSL"],
    [47.05, 8.32, "Luzern", "LUZ"],
    [46.21, 6.15, "Genève", "GVE"],
    [46.00, 8.96, "Lugano", "LUG"],
    [47.43, 9.37, "St. Gallen", "SGA"],
    [46.30, 7.88, "Visp", "VSP"],
    [46.22, 7.31, "Sion", "SIO"],
    [46.86, 9.52, "Chur", "CHU"],
    [46.87, 8.64, "Altdorf", "ALT"],
    [46.16, 8.96, "Magadino", "MGD"],
    [46.75, 7.61, "Thun", "THU"],
    [47.39, 8.06, "Aarau", "AAR"],
    [46.53, 9.88, "Samedan", "SAM"],
    [47.57, 8.91, "Frauenfeld", "FRF"],
    [47.09, 6.82, "La Chaux-de-Fonds", "CDF"],
    [47.21, 7.57, "Solothurn", "SOL"],
    [46.81, 9.84, "Davos", "DAV"],
    [46.80, 10.32, "Scuol", "SCU"],
    [46.32, 10.06, "Poschiavo", "PSC"],
    [46.77, 9.21, "Ilanz", "ILZ"],
    [46.73, 8.17, "Meiringen", "MEI"],
    [46.99, 8.06, "Entlebuch", "ENT"],
    [46.51, 8.70, "Ambrì", "AMB"],
    [46.73, 6.55, "Orbe", "ORB"],
    [47.27, 9.11, "Ebnat-Kappel", "EBK"],
    [47.36, 7.36, "Delémont", "DLM"],
    [47.56, 7.85, "Möhlin", "MOE"],
    [46.49, 7.57, "Adelboden", "ADB"],
    [47.04, 9.07, "Glarus", "GLA"],
    [46.46, 8.23, "Goms", "GOM"],
    [47.18, 9.48, "Buchs", "BCH"],
    [46.02, 7.75, "Zermatt", "ZMT"],
    [46.36, 8.96, "Biasca", "BIA"],
    [47.60, 9.30, "Güttingen", "GUT"],
    [46.20, 8.06, "Simplon", "SIM"],
    [47.70, 8.47, "Hallau", "HAL"],
    [46.26, 9.16, "Misox", "MSX"],
    [46.78, 7.12, "Fribourg", "FRB"],
    [46.30, 6.96, "Aigle", "AIG"],
    [47.18, 8.00, "Egolzwil", "EGW"],
    [47.22, 8.68, "Wädenswil", "WAE"],
    [46.60, 9.43, "Andeer", "AND"],
    [46.52, 6.66, "Lausanne", "LSN"],
    [47.42, 6.95, "Fahy", "FAH"],
    [46.46,10.37, "Bormio", "BRM"],
    [46.54,10.14, "Livigno", "LVG"]
];

const globalCities = ["Zürich","Genève","Lugano"];

let markers = [];

function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const currentModel = document.querySelector('input[name="model"]:checked').value;

    cityList.forEach(([lat, lon, city, sym]) => {
        const isGlobal = ["ECMWF","AIFS","GFS"].includes(currentModel);
        if (isGlobal && !globalCities.includes(city)) return;

        const marker = L.marker([lat, lon]).addTo(map)
            .bindTooltip(city)
            .on('click', function() {
                const selectedModel = document.querySelector('input[name="model"]:checked').value;
                const timeValue = document.getElementById('time-select').value;

                const link =
                    `https://met.metweb.ch/modelviewer/plots/${selectedModel}/meteograms/` +
                    `${timeValue}_${selectedModel}_CH_Meteogramm_${sym}.png`;

                if (galleryActive) {
                    addImageToGallery(link);
                } else if (openInNewTab) {
                    window.open(link, '_blank');
                } else {
                    window.location.href = link;
                }
            });

        markers.push(marker);
    });
}

document.querySelectorAll('input[name="model"]').forEach(r => r.addEventListener('change', fillTimes));
document.querySelectorAll('input[name="model"]').forEach(r => r.addEventListener('change', updateMarkers));

const timeSelect = document.getElementById('time-select');

function fillTimes() {
    timeSelect.innerHTML = "";

    const model = document.querySelector('input[name="model"]:checked').value;
    const now = new Date();
    now.setUTCMinutes(0,0,0);

    const offset = ["EURO1k","ICOND2"].includes(model) ? 3 : 5;
    now.setUTCHours(Math.floor((now.getUTCHours() - offset) / 6) * 6);

    for (let i=0;i<5;i++){
        const code = now.toISOString().replace(/[-:T]/g,"").slice(0,12);
        const label = `${now.getUTCDate()}. ${now.toLocaleString('de-DE',{month:'long'})} ${now.getUTCFullYear()} - ${String(now.getUTCHours()).padStart(2,'0')} UTC`;

        const o = document.createElement('option');
        o.value = code;
        o.textContent = label;
        timeSelect.appendChild(o);

        now.setUTCHours(now.getUTCHours() - 6);
    }
}

fillTimes();
updateMarkers();

let openInNewTab = false;
const btn = document.getElementById('new-tab-button');
btn.addEventListener('click', () => {
    openInNewTab = !openInNewTab;
    btn.classList.toggle('active');
    btn.textContent = openInNewTab ? 'Neuer Tab: AN' : 'Neuer Tab: AUS';
});

const galleryBtn = document.getElementById("gallery-button");
const gallerySection = document.getElementById("gallery-section");
const galleryDiv = document.getElementById("gallery");
const galleryCols = document.getElementById("gallery-cols");
const gallerySize = document.getElementById("gallery-size");

let galleryActive = false;

galleryBtn.addEventListener("click", () => {
    galleryActive = !galleryActive;
    galleryBtn.classList.toggle("active");
    galleryBtn.textContent = galleryActive ? "Galerie: AN" : "Galerie: AUS";

    gallerySection.style.display = galleryActive ? "block" : "none";

    if (galleryActive) applyGalleryLayout();
});

galleryCols.addEventListener("change", applyGalleryLayout);
gallerySize.addEventListener("input", applyGalleryLayout);

function addImageToGallery(url) {
    const item = document.createElement("div");
    item.className = "gallery-item";

    const close = document.createElement("div");
    close.className = "gallery-close";
    close.textContent = "X";
    close.onclick = (e) => {
        e.stopPropagation();
        item.remove();
    };

    const img = document.createElement("img");
    img.src = url;

    img.addEventListener("click", () => {
        if (openInNewTab) {
            window.open(url, "_blank");
        } else {
            window.location.href = url;
        }
    });

    item.appendChild(close);
    item.appendChild(img);
    galleryDiv.appendChild(item);

    applyGalleryLayout();
}

function applyGalleryLayout() {

    const cols = Number(galleryCols.value);
    const scale = Number(gallerySize.value) / 100;

    const baseWidth = 900;

    const itemWidth = Math.round((baseWidth / cols) * scale);

    galleryDiv.style.gridTemplateColumns =
        `repeat(${cols}, ${itemWidth}px)`;

    document.querySelectorAll(".gallery-item").forEach(item => {
        item.style.width = itemWidth + "px";
    });

    document.querySelectorAll(".gallery-item img").forEach(img => {
        img.style.width = itemWidth + "px";
    });

    // Alle Bilder löschen
    const galleryClear = document.getElementById("gallery-clear");
    galleryClear.addEventListener("click", () => {
        galleryDiv.innerHTML = "";
    });
}

</script>
</body>
</html>
